<html>
  <head>
    <title>Live Chat Example</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    <script src="../iris.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <div class="iris-chat-box">
      <div class="iris-chat-header">Live chat</div>
      <div class="iris-chat-messages"></div>
      <div class="iris-chat-input-wrapper">
        <form>
          <textarea rows="1" placeholder="Type a message"></textarea>
        </form>
      </div>
    </div>

    <script type="text/javascript">
      function getCaret(el) {
        if (el.selectionStart) {
            return el.selectionStart;
        } else if (document.selection) {
            el.focus();
            var r = document.selection.createRange();
            if (r == null) {
                return 0;
            }
            var re = el.createTextRange(), rc = re.duplicate();
            re.moveToBookmark(r.getBookmark());
            rc.setEndPoint('EndToStart', re);
            return rc.text.length;
        }
        return 0;
      }

      iris.Key.getDefault().then(key => {
        var gun = new Gun(['https://gun-eu.herokuapp.com/gun']);
        var chat = new iris.Chat({gun, key, participants: key.pub, onMessage: (msg, info) => {
          var msgContent = $('<div>').addClass('iris-msg-content').text(msg.text);
          msgContent.html(msgContent.html().replace(/\n/g, '<br>\n'));
          var msgEl = $('<div>').toggleClass('our', info.selfAuthored).addClass('iris-chat-message').append(msgContent);
          $('.iris-chat-messages').append(msgEl);
        }});
        var i = 0;

        $('.iris-chat-box textarea').keyup(function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                var content = this.value;
                var caret = getCaret(this);
                if (event.shiftKey){
                    this.value = content.substring(0, caret - 1) + "\n" + content.substring(caret, content.length);
                } else {
                    this.value = content.substring(0, caret - 1) + content.substring(caret, content.length);
                    chat.send(this.value);
                    this.value = '';
                }
            }
        });
      });
    </script>
  </body>
</html>
